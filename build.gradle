/*
 * This file was generated by the Gradle 'init' task.
 */

// TODO TEST switch to Kotlin DSL which is now the default and apparently better
// TODO TEST avoid early configuration, see
//           https://docs.gradle.org/current/userguide/task_configuration_avoidance.html
//           need to avoid withType as well apparently?

plugins {
	id 'java'
	id 'war'
	id 'jacoco'
	id 'org.ajoberstar.grgit' version '4.1.1'
	id 'com.github.johnrengelman.shadow' version '8.1.1'
}

var DEFAULT_URL = "https://ci.kbase.us/services/ws"

var BUILD_DOC_ROOT = "$buildDir/docs/"
var BUILD_JAVA_DOC_DIR = "$BUILD_DOC_ROOT/javadoc"
var BUILD_OTHER_DOC_DIR = "$BUILD_DOC_ROOT/otherdoc/"
// This is where the DocServer will look for docs, if it changes it needs to change
// in deploy.cfg as well
// TODO DOCS just get rid of configuring this in the DocServer, make things hardcoded
//           or pass in constructor when we subume into a Jersey style service
var IN_JAR_DOC_DIR = "/server_docs"
var IN_JAR_JAVA_DOC_DIR = "$IN_JAR_DOC_DIR/javadoc"

var LOC_WS_SPEC = "$rootDir/workspace.spec"
var LOC_DOC_HTML = "$rootDir/docshtml"

// TODO NOW update any ant refs in docs to gradle & the update schema script build & location

repositories {
	mavenCentral()
}

task buildGitCommitFile {
	doLast {
		def commitId = grgit.head().id
		// is there a variable for builddir/classes/java/main?
		file("$buildDir/classes/java/main/us/kbase/workspace/gitcommit/gitcommit").text = commitId
	}
}

compileJava {
	// build needs to be java 8 compatible so jars can be used in java 8 projects
	// TODO BUILD remove when we no longer support java 8, use `options.release = 11` if needed
	java.sourceCompatibility = JavaVersion.VERSION_1_8
	java.targetCompatibility = JavaVersion.VERSION_1_8
	finalizedBy buildGitCommitFile
}

javadoc {
	/* We don't actually need the full javadoc for anything, so just hijack this task for
	 * building the client javadocs. If we ever need the full javadocs make a new task for the
	 * client java docs
	 */
	/* TODO DOCS currently java-common and auth links don't work. ROI for fixing them is low.
	 *           Ideally, in the future make github actions publish docs on release and ref them
	 *           here.
	 *           https://github.com/marketplace/actions/deploy-publish-javadoc
	 *           https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-gradle-registry
	 */
	/* TODO DOCS the current sdk documenation looks like invalid html to javadoc
	 *           need to go through and remove
	 *           also some spots with < / > that need to be wrapped with {@code } in internal code
	 */
	failOnError = false
	options {
		links "https://docs.oracle.com/en/java/javase/11/docs/api/"
	}
	include "**/workspace/*.java"
	exclude "**/workspace/WorkspaceServer.java"
	include "**/common/service/Tuple*.java"
}

task buildDocs {
	// ideally we'd add the inputs and outputs spec but that's too much work for too little gain
	dependsOn javadoc
	doLast {
		// need to make sure we remove any docs that no longer exist in the source
		delete BUILD_OTHER_DOC_DIR
		// not needed locally, fails w/o it in docker build. *shrug*
		mkdir BUILD_OTHER_DOC_DIR
		copy {
			from LOC_WS_SPEC into BUILD_OTHER_DOC_DIR
		}
		copy {
			from LOC_DOC_HTML into BUILD_OTHER_DOC_DIR include "*"
		}
		exec {	
			commandLine "pod2html", "--infile=$rootDir/lib/Bio/KBase/workspace/Client.pm", "--outfile=$BUILD_OTHER_DOC_DIR/workspace_perl.html"
		}
		exec {
			commandLine "sphinx-build", "$rootDir/docsource/", BUILD_OTHER_DOC_DIR
		}
		delete fileTree(".").matching { include "pod2htm*.tmp" }
	}
}

tasks.withType(Test) {
	/* 
	 * TODO TEST Figure out why tests fail without this and remove. Might have something to do
	 * with the stfuLoggers() call in many of the tests, might kill logging for tests that
	 * require it
	 * Although it seems to make Mongo start up correctly as well which is odd
	 */
	forkEvery = 1
	/*
	  * TODO TEST split tests into mongo wrapper tests & all other tests (incl. integration).
	  * Set up GHA to run the non-mongo tests with a single version of mongo and run the
	  * mongo tests with matrixed mongo versions. Combine coverage at the end somehow
	*/
	systemProperty "test.cfg", "./test.cfg"
	maxHeapSize = "3G"
	testLogging {
		exceptionFormat = 'full'
		showStandardStreams = true
	}
	filter {
		// gradle thinks that classes annotated with @RunWith are tests
		excludeTestsMatching "*Tester"
	}
}

tasks.withType(JacocoReport) {
	reports {
		xml.required = true
		csv.required = true
	}
}

test {
	finalizedBy jacocoTestReport
}

task testQuick(type: Test) {
	// for Gradle 9.0 compatibility
	testClassesDirs = testing.suites.test.sources.output.classesDirs
	classpath = testing.suites.test.sources.runtimeClasspath

	filter {
		excludeTestsMatching "*LongTest"
	}
	finalizedBy "jacocoTestQuickReport" // must be a string, see TODOs at head of file
}

task jacocoTestQuickReport(type: JacocoReport, dependsOn: testQuick) {
	sourceSets sourceSets.main
	executionData(testQuick)
}

jar {
	// Much like javadoc, we hijack this task to build the client jar, since we don't need
	// a service jar
	include "us/kbase/workspace/*.class"
	exclude "us/kbase/workspace/WorkspaceServer*.class"  // exclude anonymous classes
	include "us/kbase/common/service/Tuple*.class"
	archiveAppendix = 'client'
}

shadowJar {
	// Be careful when updating jars - you may want to set the duplicates strategy to WARN
	// to see if any of the jars are shadowing the others when building the fat jar, which
	// has been the case in the past
	dependsOn buildDocs
	duplicatesStrategy = DuplicatesStrategy.EXCLUDE
	archiveAppendix = 'test-shadow'
	from sourceSets.test.output
	// we don't want to package the auth shadow jar, so no test runtime classpath
	configurations = [project.configurations.runtimeClasspath]

	enableRelocation true
	relocationPrefix 'us.kbase.workspace.shadow'
	
	mergeServiceFiles()
	
	from(BUILD_JAVA_DOC_DIR) { into IN_JAR_JAVA_DOC_DIR }
	from(BUILD_OTHER_DOC_DIR) { into IN_JAR_DOC_DIR }
}

war {
	dependsOn buildDocs
	webXml = file('war/web.xml')
	from(BUILD_JAVA_DOC_DIR) { into "/WEB-INF/classes/$IN_JAR_JAVA_DOC_DIR" }
	from(BUILD_OTHER_DOC_DIR) { into "/WEB-INF/classes/$IN_JAR_DOC_DIR" }
}

/* SDK compile notes:
 * kb-sdk starts a docker container in interactive mode. Gradle's commandLine doesn't allocate
 * a tty so the command fails.
 * I tried using a ProcessBuilder and
 * https://docs.oracle.com/en%2Fjava%2Fjavase%2F11%2Fdocs%2Fapi%2F%2F/java.base/java/lang/ProcessBuilder.html#inheritIO()
 * but that failed also with no useful output.
 * 
 * The current solution is to precede the kb-sdk call with a script call, which either
 * allocates a tty or fools kb-sdk into thinking there is one - not quite sure.
 * https://man7.org/linux/man-pages/man1/script.1.html
 * I tried to redirect the script log file  to /dev/null with -O and --log-out but script didn't
 * recognize either option, hence the delete.
 *
 * This is, generally speaking, a janky mess and if someone can find a better way to do this
 * that'd be fantastic.
 */
 
 var LOC_SCRIPT_TYPESCRIPT = "$rootDir/typescript"

// TODO GRADLE is there some way to DRY these 3 compile tasks up? Not a huge deal
task sdkCompileHTML {
	// We want to check in the HTML so we don't put it in the build dir
	var cmd = "kb-sdk compile --html --out $LOC_DOC_HTML $LOC_WS_SPEC"
	doLast {
		exec {
			commandLine "script", "-qefc", cmd
		}
		delete LOC_SCRIPT_TYPESCRIPT
	}
}

task sdkCompileLibs {
	var cmd = "kb-sdk compile " +
				"--out lib " +
				"--jsclname javascript/workspace/Client " +
				"--plclname Bio::KBase::workspace::Client " +
				"--pyclname biokbase.workspace.client " +
				"--url $DEFAULT_URL " + 
				LOC_WS_SPEC
	doLast {
		exec {
			commandLine "script", "-qefc", cmd
		}
		delete LOC_SCRIPT_TYPESCRIPT
		delete "$rootDir/lib/biokbase/workspace/authclient.py"
	}
}

task sdkCompileJava {
	// TODO GRADLE is there a variable for src/main/java?
	var cmd = "kb-sdk compile " +
				"--java " +
				"--javasrc $rootDir/src/main/java/ " +
				"--javasrv " +
				"--out . " +
				"--url $DEFAULT_URL " + 
				LOC_WS_SPEC
	doLast {
		exec {
			commandLine "script", "-qefc", cmd
		}
		delete LOC_SCRIPT_TYPESCRIPT
	}
}

task sdkCompile {
	dependsOn sdkCompileHTML
	dependsOn sdkCompileJava
	dependsOn sdkCompileLibs
}

task generateUpdateSchemaScript {
	dependsOn compileJava
	doLast {
		def dependencies = configurations.runtimeClasspath.collect { File file ->
			file.absolutePath
		}
	
		def classpath = dependencies.join(':')
	
		def scriptContent = """#!/bin/sh

CLASSPATH=$classpath

java -cp $buildDir/classes/java/main:\$CLASSPATH us.kbase.workspace.kbase.SchemaUpdaterCLI \$@
"""
		def outfile = "$buildDir/update_workspace_database_schema"
		file(outfile).text = scriptContent
		file(outfile).setExecutable(true)
	}
}

configurations {
	// can't directly access testImplementation, so extend and access
	testimpl.extendsFrom testImplementation
}

def fromURL = { url, name ->
	File file = new File("$buildDir/download/${name}.jar")
	file.parentFile.mkdirs()
	if (!file.exists()) {
		new URL(url).withInputStream { downloadStream ->
			file.withOutputStream { fileOut ->
				fileOut << downloadStream
			}
		}
	}
	files(file.absolutePath)
}

dependencies {

	// ### General application dependencies ###
	
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/handle/AbstractHandleClient-1.0.0.jar',
		'AbstractHandleClient-1.0.0'
	)
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/auth/kbase-auth-0.4.4.jar',
		'kbase-auth-0.4.4'
	)
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/kidl/kbase-kidl-parser-1409261812-7863aef.jar',
		'kbase-kidl-parser-1409261812-7863aef'
	)
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/sample/SampleServiceClient-0.1.1.jar',
		'SampleServiceClient-0.1.1'
	)
	implementation 'ch.qos.logback:logback-classic:1.1.2'
	implementation 'com.google.guava:guava:14.0.1'
	implementation 'com.github.ben-manes.caffeine:caffeine:2.9.3'
	implementation 'commons-codec:commons-codec:1.8'
	implementation 'commons-io:commons-io:2.4'
	implementation 'com.fasterxml.jackson.core:jackson-annotations:2.9.9'
	implementation 'com.fasterxml.jackson.core:jackson-core:2.9.9'
	implementation 'com.fasterxml.jackson.core:jackson-databind:2.9.9'
	implementation 'info.picocli:picocli:4.6.1'
	implementation 'org.apache.commons:commons-lang3:3.1'
	implementation 'org.apache.kafka:kafka-clients:2.1.0'
	implementation 'org.ini4j:ini4j:0.5.2'
	implementation 'org.mongodb:bson:4.11.1'
	implementation 'org.mongodb:bson-record-codec:4.11.1'
	implementation 'org.mongodb:mongodb-driver-core:4.11.1'
	implementation 'org.mongodb:mongodb-driver-sync:4.11.1'
	implementation 'org.slf4j:slf4j-api:1.7.30'
	
	// ### Server dependencies, specifically for java_common JsonServerServlet ###
	
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/common/kbase-common-0.2.0.jar',
		'kbase-common-0.2.0'
	)
	// Pull from jars repo vs a maven repository to avoid the JNA dependency
	// TODO DEPS Need to rework the java common logger to not use syslog4j at all since it's abandonware
	// and has a ton of CVEs, even in the newer versions.
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/syslog4j/syslog4j-0.9.46.jar',
		'syslog4j-0.9.46'
	)
	implementation 'javax.annotation:javax.annotation-api:1.3.2'
	implementation 'javax.servlet:servlet-api:2.5'
	// joda-time is required for kbase-common and syslog4j
	implementation 'joda-time:joda-time:2.2'
	// this is OOOOOOLD. But that probably means updating java_common
	implementation 'org.eclipse.jetty.aggregate:jetty-all:7.0.0.v20091005'
	
	// ### Blobstore / Shock client and dependencies ###
	
	implementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/shock/shock-client-0.1.0.jar',
		'shock-client-0.1.0'
	)
	implementation 'org.apache.httpcomponents:httpclient:4.5.9'
	implementation 'org.apache.httpcomponents:httpmime:4.5.8'

	// ### Amazon S3 ###
	
	implementation('software.amazon.awssdk:s3:2.17.214') {
		exclude module: 'apache-client'
		exclude module: 'netty-nio-client'
	}
	implementation 'software.amazon.awssdk:url-connection-client:2.17.214'
	
	// ### Test ###
	
	testImplementation fromURL(
		'https://github.com/kbase/jars/raw/master/lib/jars/kbase/auth2/kbase-auth2-test-shadow-all-0.7.0.jar',
		'kbase-auth2-test-shadow-all-0.7.0'
	)
	testImplementation 'com.arangodb:arangodb-java-driver:6.7.2'
	testImplementation 'com.github.zafarkhaja:java-semver:0.9.0'
	testImplementation 'junit:junit:4.12'
	testImplementation 'nl.jqno.equalsverifier:equalsverifier:3.1.10'
	testImplementation 'org.hamcrest:hamcrest-core:1.3'
	testImplementation 'org.mockito:mockito-core:3.0.0'
	
}

task showTestClassPath {
	doLast {
		configurations.testimpl.each { println it }
	}
}

