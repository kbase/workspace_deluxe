/*
 * This file was generated by the Gradle 'init' task.
 */

// TODO TEST switch to Kotlin DSL which is now the default and apparently better
// TODO TEST avoid early configuration, see
//           https://docs.gradle.org/current/userguide/task_configuration_avoidance.html
//           need to avoid withType as well apparently?

plugins {
	id 'java'
	id 'maven-publish'
}

group = 'com.github.kbase'

var VER_JAVA_COMMON = "0.3.0"
var VER_AUTH2_CLIENT = "0.5.0"


var DEFAULT_URL = "https://ci.kbase.us/services/ws"

var LOC_WS_SPEC = "$rootDir/workspace.spec"

repositories {
	mavenCentral()
	maven {
		name = "Jitpack"
		url = 'https://jitpack.io'
	}
}

compileJava {
	// build needs to be java 8 compatible so jars can be used in java 8 projects
	// TODO BUILD remove when we no longer support java 8, use `options.release = 11` if needed
	java.sourceCompatibility = JavaVersion.VERSION_1_8
	java.targetCompatibility = JavaVersion.VERSION_1_8
}

java {
	withSourcesJar()
	withJavadocJar()
}

javadoc {
	/* TODO DOCS the current sdk documentation looks like invalid html to javadoc
	 *           need to go through and remove
	 *           also some spots with < / > that need to be wrapped with {@code } in internal code
	 */
	failOnError = false
	options {
		links "https://docs.oracle.com/en/java/javase/11/docs/api/"
		links "https://javadoc.jitpack.io/com/github/kbase/auth2_client_java/$VER_AUTH2_CLIENT/javadoc/"
		links "https://javadoc.jitpack.io/com/github/kbase/java_common/$VER_JAVA_COMMON/javadoc/"
	}
}

/* SDK compile notes:
 * kb-sdk starts a docker container in interactive mode. Gradle's commandLine doesn't allocate
 * a tty so the command fails.
 * I tried using a ProcessBuilder and
 * https://docs.oracle.com/en%2Fjava%2Fjavase%2F11%2Fdocs%2Fapi%2F%2F/java.base/java/lang/ProcessBuilder.html#inheritIO()
 * but that failed also with no useful output.
 * 
 * The current solution is to precede the kb-sdk call with a script call, which either
 * allocates a tty or fools kb-sdk into thinking there is one - not quite sure.
 * https://man7.org/linux/man-pages/man1/script.1.html
 * I tried to redirect the script log file  to /dev/null with -O and --log-out but script didn't
 * recognize either option, hence the delete.
 *
 * This is, generally speaking, a janky mess and if someone can find a better way to do this
 * that'd be fantastic.
 */
 
var LOC_SCRIPT_TYPESCRIPT = "./typescript"

task sdkCompileJava {
	// TODO GRADLE is there a variable for src/main/java?
	var cmd = "kb-sdk compile " +
				"--java " +
				"--javasrc ${project.projectDir}/src/main/java/ " +
				"--out . " +
				"--url $DEFAULT_URL " + 
				LOC_WS_SPEC
	doLast {
		exec {
			commandLine "script", "-qefc", cmd
		}
		delete LOC_SCRIPT_TYPESCRIPT
	}
}

task sdkCompile {
	dependsOn sdkCompileJava
}

task buildAll {
	dependsOn jar
}

publishing {
	publications {
		maven(MavenPublication) {
			from components.java
			artifactId = "workspace-client"
		}
	}
}

dependencies {
	// using older dependencies to not force upgrades on services that might not be able to
	// handle them. Need to upgrade the services and then upgrade here
	implementation "com.fasterxml.jackson.core:jackson-annotations:2.5.4"
	implementation "com.fasterxml.jackson.core:jackson-databind:2.5.4"
	implementation "com.github.kbase:auth2_client_java:$VER_AUTH2_CLIENT"
	implementation "com.github.kbase:java_common:$VER_JAVA_COMMON"
	implementation 'javax.annotation:javax.annotation-api:1.3.2'
}
